name: Android - Play Store Internal Testing

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Release notes for this Android build"
        required: false
        default: "Android internal testing build from CI"
  push:
    tags:
      - "android-v*"

jobs:
  android-internal:
    name: Build & upload to Google Play (internal testing)
    runs-on: ubuntu-latest

    env:
      ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME || 'com.dojowell.dev' }}
      RELEASE_NOTES: ${{ github.event.inputs.release_notes || 'Android internal testing build from CI' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install JS dependencies
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Make Gradle wrapper executable
        working-directory: android
        run: chmod +x gradlew

      - name: Create local.properties (SDK + Airbridge keys)
        working-directory: android
        env:
          AIRBRIDGE_NAME: ${{ secrets.AIRBRIDGE_NAME }}
          AIRBRIDGE_TOKEN: ${{ secrets.AIRBRIDGE_TOKEN }}
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          if [ -n "$AIRBRIDGE_NAME" ]; then
            echo "airbridge.name=$AIRBRIDGE_NAME" >> local.properties
          fi
          if [ -n "$AIRBRIDGE_TOKEN" ]; then
            echo "airbridge.token=$AIRBRIDGE_TOKEN" >> local.properties
          fi

      - name: Create release keystore & keystore.properties
        working-directory: android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "ANDROID_KEYSTORE_BASE64 is not set; cannot create release keystore."
            exit 1
          fi
          mkdir -p app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/release.keystore
          cat <<EOF > keystore.properties
          storeFile=app/release.keystore
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_ALIAS_PASSWORD
          EOF

      - name: Create Google Play service account file
        working-directory: android
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          mkdir -p fastlane
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > fastlane/google-play-service-account.json

      - name: Build & upload via Fastlane
        working-directory: android
        env:
          ANDROID_PACKAGE_NAME: ${{ env.ANDROID_PACKAGE_NAME }}
          RELEASE_NOTES: ${{ env.RELEASE_NOTES }}
        run: |
          bundle install
          bundle exec fastlane android internal release_notes:"$RELEASE_NOTES"


